# 📱 obniz で学ぶリアルタイムIoT制御ハンズオン

本資料では、obnizを使った4人同時リアルタイム制御と、Google認証を使ったセキュアなWebサービス連携を学習します。
JavaScriptでIoTデバイスを制御する基礎から、実用的な認証・ログ記録まで段階的に習得できます。

## 📚 目次

1. [ハンズオン概要](#-ハンズオン概要)
2. [事前準備](#-事前準備)
3. [ハードウェア構成](#-ハードウェア構成)
4. [基本の流れ](#-基本の流れ)
5. [サンプルコードの動作確認](#-サンプルコードの動作確認)
6. [課題1: センサー値を%に変換](#-課題1-センサー値をに変換)
7. [課題2: スライダーを使ったLED制御](#-課題2-スライダーを使ったled制御)
8. [課題3: 自動調光ライト](#-課題3-自動調光ライト)
9. [課題4: リアルタイム状態モニタ](#-課題4-リアルタイム状態モニタ)
10. [課題5: 実用的な認証を持つログ記録](#-課題5-実用的な認証を持つログ記録)
11. [参考資料](#-参考資料)

---

## 🎯 ハンズオン概要

### 目的

obnizを通じた4人同時リアルタイム制御と、Google認証を使ったセキュアなWebサービス連携の学習。

### 仕様

| 項目 | 詳細 |
|:---|:---|
| **参加人数** | 4人（obniz 1台を共有） |
| **識別方法** | LEDポート番号を直接指定（0-3） |
| **ログ認証** | Googleアカウント認証（IDトークン使用） |
| **所要時間** | 60-90分（基礎部分は60分以内） |

### タイムライン

| 時間 | 内容 |
|:---|:---|
| **0-10分** | ハンズオン説明・環境確認 |
| **10-30分** | ハードウェア構成説明・サンプルコード動作確認 |
| **30-60分** | 基本操作の理解（LED ON/OFF、センサー値取得） |
| **60-90分** | 課題1-4に挑戦（応用編） |

---

## 🔧 事前準備

### 必要な環境

参加者は以下の環境を準備してください。

- **Webブラウザ**: Chrome、Edge、Firefoxなど最新版
- **テキストエディタ**: VSCode推奨（HTML/CSS/JavaScript対応）
- **Node.js**: 課題5で使用（バージョン14以降推奨）
  - インストール確認: `node -v`でバージョンが表示されればOK
  - 未インストールの場合: [nodejs.org](https://nodejs.org/)からダウンロード
- **Airtableアカウント**: 課題5で使用（無料）
  - [airtable.com](https://airtable.com/)で登録

### 配布物

当日、以下を配布します。

- **LEDポート番号**: 各参加者に0-3のいずれかを割り当て
- **サンプルコード**: HTML/JavaScriptファイル
- **obniz ID**: 共有するobnizボードの識別番号

---

## 🔌 ハードウェア構成

### 接続図

obnizボードには以下のように部品を接続します。

| 接続先 | 部品 | ポート番号 | 備考 |
|:---|:---|:---|:---|
| **LED 1** | 赤色LED + 抵抗270Ω | GPIO 0 | 参加者1用 |
| **LED 2** | 黄色LED + 抵抗270Ω | GPIO 1 | 参加者2用 |
| **LED 3** | 緑色LED + 抵抗270Ω | GPIO 2 | 参加者3用 |
| **LED 4** | 青色LED + 抵抗270Ω | GPIO 3 | 参加者4用 |
| **明るさセンサー** | CdSセル + 固定抵抗 | A0 (Analog) | 全員で共有 |

### 配線のポイント

- LEDは極性があります（長い足が+、短い足が-）
- **anode（+側）**: 各参加者のGPIOポート（0-3）に接続
- **cathode（-側）**: GNDに接続（全LED共通）
- 抵抗は270Ωを使用し、LEDの保護と適切な明るさを確保
- CdSセルは分圧回路で接続し、明るさを電圧値（0-3.3V）として読み取り
- **重要**: obnizのアナログ入力は最大3.3Vです。5Vを入力すると故障の可能性があります

---

## 🚀 基本の流れ
├── index.html          # メインのHTMLファイル
└── script.js           # JavaScript制御ロジック
```

### 動作確認手順

#### 1. HTMLファイルを開く

`index.html`をWebブラウザで開きます。

#### 2. obniz IDとポート番号を入力

画面に表示される入力欄に、以下を入力します。

- obniz ID: 配布されたobniz IDを入力
- LEDポート番号: 割り当てられたポート番号（0-3）を入力

「接続」ボタンをクリックします。

#### 3. 接続確認

接続が成功すると、以下が表示されます。

- 「接続成功！あなたのLEDポート: X」というメッセージ
- LED制御ボタン（ON/OFF）
- センサー値の表示エリア

#### 5. LEDを点灯

「LED ON」ボタンをクリックし、自分のLEDが点灯することを確認します。

#### 6. センサー値を確認

画面に表示されるセンサー値が、CdSセルに光を当てたり遮ったりすることで変化することを確認します。

### コードの解説

#### HTML部分（index.html）

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>obniz LED制御</title>
</head>
<body>
    <h1>obniz LED制御</h1>
    
    <div id="connection-area">
        <input type="text" id="obniz-id" placeholder="obniz ID">
        <input type="number" id="led-port" placeholder="LEDポート番号 (0-3)" min="0" max="3">
        <button id="connect-btn">接続</button>
    </div>
    
    <div id="control-area" style="display: none;">
        <h2>LED制御</h2>
        <button id="led-on-btn">LED ON</button>
        <button id="led-off-btn">LED OFF</button>
        
        <h2>センサー値</h2>
        <p>明るさ: <span id="brightness-value">--</span></p>
    </div>
    
    <script src="https://unpkg.com/obniz/obniz.js"></script>
    <script src="script.js"></script>
</body>
</html>
```

#### JavaScript部分（script.js）

```javascript
let obniz;
let myPort;
let led;

// 接続ボタンのクリックイベント
document.getElementById('connect-btn').addEventListener('click', async () => {
    const obnizId = document.getElementById('obniz-id').value;
    myPort = parseInt(document.getElementById('led-port').value);
    
    // 入力チェック
    if (!obnizId || myPort < 0 || myPort > 3 || isNaN(myPort)) {
        alert('obniz IDとLEDポート番号（0-3）を正しく入力してください');
        return;
    }
    
    // obnizに接続
    obniz = new Obniz(obnizId);
    
    obniz.onconnect = async () => {
        console.log('obnizに接続しました');
        alert(`接続成功！あなたのLEDポート: ${myPort}`);
        
        // LEDオブジェクトを作成
        led = obniz.wired('LED', { anode: myPort, cathode: 'gnd' });
        
        // センサー値の定期取得と共有（500ms間隔）
        setInterval(() => {
            const voltage = obniz.ad0.value;
            if (voltage !== null) {
                // 自分の画面に表示
                document.getElementById('brightness-value').textContent = 
                    voltage.toFixed(2) + ' V';
                
                // 全員に共有
                obniz.send({ 
                    type: 'sensor_update', 
                    voltage: voltage,
                    from: myPort 
                });
            }
        }, 500);
        
        document.getElementById('control-area').style.display = 'block';
    };
    
    // メッセージ受信
    obniz.onmessage = (message) => {
        // センサー値の受信（他の参加者からも受信）
        if (message.type === 'sensor_update') {
            console.log(`ポート${message.from}からセンサー値: ${message.voltage}V`);
        }
        
        // LED状態の受信
        if (message.type === 'led_update') {
            console.log(`ポート${message.port}: ${message.state}`);
        }
    };
});

// LED ONボタン
document.getElementById('led-on-btn').addEventListener('click', () => {
    if (led) {
        led.on();
        // 状態を全員に共有
        obniz.send({ type: 'led_update', port: myPort, state: 'on' });
    }
});

// LED OFFボタン
document.getElementById('led-off-btn').addEventListener('click', () => {
    if (led) {
        led.off();
        // 状態を全員に共有
        obniz.send({ type: 'led_update', port: myPort, state: 'off' });
    }
});
```

### 動作のポイント

- `obniz.wired()`でLEDオブジェクトを作成
- `led.on()` / `led.off()`で直接LED制御
- `obniz.ad0.value`でアナログ入力（センサー値）を取得
- `obniz.send()`で全参加者にメッセージを送信
- `obniz.onmessage`で他の参加者からのメッセージを受信
- `setInterval()`で定期的にセンサー値を読み取り・共有

---

## 📊 課題1: センサー値を%に変換

### 目標

obnizから送られてくる電圧値（0.0-3.3V）を、パーセント表示（0-100%）に変換して表示します。

### 変換の考え方

電圧値を%に変換するには、以下の計算を行います：

```
パーセント = (電圧値 / 3.3) × 100
```

例：
- 0.0V → 0%
- 1.65V → 50%
- 3.3V → 100%

### 実装手順

#### 1. HTMLに%表示エリアを追加

`index.html`のセンサー値表示部分に、%表示を追加します。

```html
<h2>☀️ センサー値</h2>
<p>電圧: <span id="brightness-value">--</span> V</p>
<p>明るさ: <span id="brightness-percent">--</span> %</p>
```

#### 2. JavaScriptで%変換処理を追加

`script.js`のセンサー値取得部分を以下のように修正します。

```javascript
// センサー値の定期取得（500ms間隔）
setInterval(() => {
    const voltage = obniz.ad0.value;
    if (voltage !== null) {
        // 電圧値を表示
        document.getElementById('brightness-value').textContent = 
            voltage.toFixed(2);
        
        // 電圧値を%に変換
        const percent = Math.round((voltage / 3.3) * 100);
        document.getElementById('brightness-percent').textContent = percent;
    }
}, 500);
```

### 確認

CdSセルに光を当てたり遮ったりして、電圧値と%表示が連動して変化することを確認します。

---

## 🎨 課題2: スライダーを使ったLED制御

### 目標

HTMLにスライダー要素を追加し、自分のLEDの明るさを無段階に手動制御します。



### 実装手順

#### 1. HTMLにスライダーを追加

`index.html`の制御エリアに以下を追加します。

```html
<h2>明るさ調整</h2>
<input type="range" id="brightness-slider" min="0" max="100" value="50">
<span id="brightness-percent">50</span>%
```

#### 2. JavaScriptでスライダーイベントを処理

`script.js`に以下を追加します。

```javascript
// スライダーの変更イベント
document.getElementById('brightness-slider').addEventListener('input', (e) => {
    const ratio = parseInt(e.target.value);
    document.getElementById('brightness-percent').textContent = ratio;
    
    // PWM制御
    if (led) {
        if (ratio === 0) {
            led.off();
        } else {
            led.pwm({ freq: 1000, duty: ratio });
        }
    }
});
```

### 確認

スライダーを動かすと、LEDの明るさがリアルタイムに変化することを確認します。

---

## 🌙 課題3: 自動調光ライト

### 目標

CdSセンサーの値に連動させ、自分のLEDの明るさを自動的に調整します。
周囲が暗くなるとLEDが明るくなり、明るくなるとLEDが暗くなる仕組みです。

### 実装手順

#### 1. センサー値の受信処理を修正

`script.js`の`onmessage`内の`brightness_update`処理を以下のように修正します。

```javascript
// センサー値の定期取得（500ms間隔）
setInterval(() => {
    const voltage = obniz.ad0.value;
    if (voltage !== null) {
        document.getElementById('brightness-value').textContent = 
            voltage.toFixed(2);
        
        // 電圧値を0-100の範囲に変換
        const sensorPercent = (voltage / 3.3) * 100;
        
        // 反比例計算: 暗い → LEDを明るく
        const ledRatio = Math.round(100 - sensorPercent);
        
        // 自動でLED明るさを調整
        if (led) {
            if (ledRatio === 0) {
                led.off();
            } else {
                led.pwm({ freq: 1000, duty: ledRatio });
            }
        }
    }
}, 500);
```

### 確認

CdSセルに光を当てたり遮ったりして、LEDの明るさが自動的に変化することを確認します。

---

## 📊 課題4: リアルタイム状態モニタ

### 目標

参加者全員のLED操作と、共通のCdSセンサー値をリアルタイムで一覧表示するダッシュボードを作成します。

### 実装手順

#### 1. HTMLにモニタエリアを追加

```html
<h2>全体モニタ</h2>
<div id="monitor-area">
    <h3>LED状態</h3>
    <ul id="led-status-list">
        <li>ポート0: <span id="led-0-status">--</span></li>
        <li>ポート1: <span id="led-1-status">--</span></li>
        <li>ポート2: <span id="led-2-status">--</span></li>
        <li>ポート3: <span id="led-3-status">--</span></li>
    </ul>
    
    <h3>共通センサー</h3>
    <p>明るさ: <span id="common-brightness">--</span></p>
</div>
```

#### 2. JavaScriptで状態更新を処理

```javascript
obniz.onmessage = (message) => {
    // ... 既存の処理 ...
    
    // LED状態の更新
    if (message.type === 'led_state_update') {
        const port = message.port;
        const state = message.state;
        document.getElementById(`led-${port}-status`).textContent = state;
    }
    
    // センサー値の更新
    if (message.type === 'brightness_update') {
        document.getElementById('common-brightness').textContent = 
            message.value.toFixed(2);
    }
};
```

### 確認

LED操作やセンサー値のログをAirtableに記録し、外部サービスとの連携を学習します。
Airtableはスプレッドシート感覚で使えるデータベースサービスで、REST APIで簡単にデータを保存・取得できます。

### Airtableとは

**Airtable**は、スプレッドシートとデータベースの良いところを組み合わせたサービスです。

- **視覚的**: スプレッドシート感覚で確認できる
- **REST API**: JavaScriptから簡単にアクセス可能
- **無料**: 1,200レコードまで無料（ハンズオンには十分）
- **リアルタイム**: データがすぐに反映される

### 実装手順

#### 1. Airtableのセットアップ

##### アカウント作成

1. [airtable.com](https://airtable.com/)にアクセス
2. 「Sign up for free」をクリック
3. メールアドレスで登録（Googleアカウントでも可）

##### ベースの作成

1. ログイン後、「Add a base」→「Start from scratch」をクリック
2. ベース名を「obniz ハンズオン」に変更
3. テーブル名を「操作ログ」に変更

##### フィールドの設定

デフォルトのフィールドを以下のように変更します：

| フィールド名 | タイプ | 説明 |
|:---|:---|:---|
| Name | Single line text | 削除（使用しない） |
| ポート | Number | LEDポート番号（0-3） |
| 操作 | Single line text | 操作内容（例: LED ON） |
| 電圧 | Number | センサー電圧値 |
| タイムスタンプ | Date | 操作日時 |

> **ヒント**: フィールド名をクリックして「Customize field type」で変更できます

##### Personal Access Tokenの取得

1. 右上のアカウントアイコン→「Developer hub」をクリック
2. 「Personal access tokens」→「Create new token」
3. トークン名: 「obniz-handson」
4. スコープ: 「data.records:write」と「data.records:read」を選択
5. アクセス: 作成したベースを選択
6. 「Create token」をクリックしてトークンをコピー

> **重要**: トークンは一度しか表示されないので、必ずコピーして保存してください

##### Base IDの取得

1. ベースを開いた状態で「Help」→「API documentation」をクリック
2. 「AUTHENTICATION」セクションに表示されるURLから`app`で始まるIDをコピー
   - 例: `https://api.airtable.com/v0/appXXXXXXXXXXXXXX/操作ログ`
   - この`appXXXXXXXXXXXXXX`がBase ID

#### 2. HTMLの準備

`challenge5.html`を作成します。

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課題5: Airtableログ記録</title>
</head>
<body>
    <h1>課題5: Airtableログ記録</h1>
    
    <div id="connection-area">
        <h2>接続</h2>
        <input type="text" id="obniz-id" placeholder="obniz ID">
        <input type="number" id="led-port" placeholder="LEDポート (0-3)" min="0" max="3">
        <button id="connect-btn">接続</button>
        <p id="status"></p>
    </div>
    
    <div id="control-area" style="display: none;">
        <h2>LED制御</h2>
        <button id="led-on-btn">LED ON</button>
        <button id="led-off-btn">LED OFF</button>
        
        <h2>センサー値</h2>
        <p>電圧: <span id="voltage">--</span> V</p>
        
        <h2>ログ記録</h2>
        <button id="save-log-btn">現在の状態をログに保存</button>
        
        <h2>最新ログ（10件）</h2>
        <button id="load-logs-btn">ログを読み込む</button>
        <ul id="logs-list"></ul>
    </div>
    
    <script src="https://unpkg.com/obniz/obniz.js"></script>
    <script src="script.js"></script>
</body>
</html>
```

#### 3. JavaScriptの実装

`script.js`を作成します。

```javascript
// Airtable設定
const AIRTABLE_TOKEN = 'あなたのPersonal Access Token';
const BASE_ID = 'あなたのBase ID';
const TABLE_NAME = '操作ログ';

let obniz;
let myPort;
let led;
let currentVoltage = 0;

// 接続処理
document.getElementById('connect-btn').addEventListener('click', async () => {
    const obnizId = document.getElementById('obniz-id').value.trim();
    myPort = parseInt(document.getElementById('led-port').value);
    
    if (!obnizId || isNaN(myPort) || myPort < 0 || myPort > 3) {
        alert('入力内容を確認してください');
        return;
    }
    
    obniz = new Obniz(obnizId);
    
    obniz.onconnect = async () => {
        document.getElementById('status').textContent = '接続成功！';
        document.getElementById('control-area').style.display = 'block';
        
        // LEDオブジェクトを作成
        led = obniz.wired('LED', { anode: myPort, cathode: 'gnd' });
        
        // センサー値の定期取得
        setInterval(() => {
            currentVoltage = obniz.ad0.value;
            if (currentVoltage !== null) {
                document.getElementById('voltage').textContent = 
                    currentVoltage.toFixed(2);
            }
        }, 500);
    };
});

// LED ON
document.getElementById('led-on-btn').addEventListener('click', () => {
    if (led) {
        led.on();
        saveLog('LED ON');
    }
});

// LED OFF
document.getElementById('led-off-btn').addEventListener('click', () => {
    if (led) {
        led.off();
        saveLog('LED OFF');
    }
});

// ログ保存ボタン
document.getElementById('save-log-btn').addEventListener('click', () => {
    saveLog('手動保存');
});

// ログ読み込みボタン
document.getElementById('load-logs-btn').addEventListener('click', () => {
    loadLogs();
});

// Airtableにログを保存
async function saveLog(action) {
    try {
        const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}`,
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    records: [{
                        fields: {
                            'ポート': myPort,
                            '操作': action,
                            '電圧': currentVoltage,
                            'タイムスタンプ': new Date().toISOString()
                        }
                    }]
                })
            }
        );
        
        const data = await response.json();
        
        if (response.ok) {
            console.log('ログ保存成功:', data);
            alert('ログを保存しました！');
        } else {
            console.error('エラー:', data);
            alert('ログ保存に失敗しました');
        }
    } catch (error) {
        console.error('通信エラー:', error);
        alert('通信エラーが発生しました');
    }
}

// Airtableからログを読み込む
async function loadLogs() {
    try {
        const response = await fetch(
            `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}?maxRecords=10&sort[0][field]=タイムスタンプ&sort[0][direction]=desc`,
            {
                headers: {
                    'Authorization': `Bearer ${AIRTABLE_TOKEN}`
                }
            }
        );
        
        const data = await response.json();
        
        if (response.ok) {
            displayLogs(data.records);
        } else {
            console.error('エラー:', data);
            alert('ログ読み込みに失敗しました');
        }
    } catch (error) {
        console.error('通信エラー:', error);
        alert('通信エラーが発生しました');
    }
}

// ログを表示
function displayLogs(records) {
    const logsList = document.getElementById('logs-list');
    logsList.innerHTML = '';
    
    records.forEach(record => {
        const fields = record.fields;
        const li = document.createElement('li');
        const timestamp = new Date(fields['タイムスタンプ']).toLocaleString('ja-JP');
        li.textContent = `[${timestamp}] ポート${fields['ポート']}: ${fields['操作']} (${fields['電圧']}V)`;
        logsList.appendChild(li);
    });
}
```

### 確認

1. HTTPサーバーを起動して`http://localhost:8000/challenges/challenge5.html`にアクセス
2. obnizに接続
3. LED操作を行うと、自動的にAirtableにログが保存される
4. 「ログを読み込む」ボタンで最新10件のログを表示
5. Airtableのベースを開いて、実際にデータが保存されていることを確認

### ポイント

- **REST API**: `fetch()`を使った外部APIとの通信を学習
- **認証**: Bearer Tokenを使った認証方法を理解
- **データ形式**: JSONでのデータ送受信
- **エラーハンドリング**: try-catchでのエラー処理
- **非同期処理**: async/awaitの使い方

### 発展課題

余裕があれば、以下の機能を追加してみましょう：

1. **フィルタリング**: 自分のポートのログのみ表示
2. **グラフ化**: センサー値の推移をグラフで表示
3. **削除機能**: 古いログを削除する機能
4. **リアルタイム更新**: 定期的にログを自動読み込み

---

## 📚 参考資料

### obniz公式ドキュメント

- [obniz公式サイト](https://obniz.com/ja/)
- [obniz.js リファレンス](https://obniz.com/ja/doc/reference/obnizjs)

### Airtable API

- [Airtable API Documentation](https://airtable.com/developers/web/api/introduction)
- [REST API Basics](https://airtable.com/developers/web/api/rest-api-basics)

### JavaScript

- [fetch API](https://developer.mozilla.org/ja/docs/Web/API/Fetch_API)
- [async/await](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Statements/async_function)

---

## 🎉 まとめ

本ハンズオンでは、以下を学習しました。

1. **基礎**: obnizを使ったLED制御とセンサー値取得
2. **課題1**: 電圧値を%に変換
3. **課題2**: PWM制御による明るさ調整
4. **課題3**: センサー連動による自動制御
5. **課題4**: リアルタイム状態モニタリング
6. **課題5**: Airtableを使った外部サービス連携

これらの技術を組み合わせることで、実用的なIoTアプリケーションを構築できます。

### 次のステップ

- 複数のセンサーを組み合わせた制御
- データの可視化（Chart.jsなどでグラフ表示）
- 他のサービスとの連携（Discord、Slack、LINEなど）
- スマートフォンアプリとの連携

お疲れ様でした！