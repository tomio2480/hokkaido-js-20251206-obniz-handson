<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課題5: 実用的な認証を持つログ記録</title>
    <script src="https://cdn.tailwindcss.com/4.0.0-beta.6"></script>
</head>
<body class="p-8 max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">課題5: 実用的な認証を持つログ記録</h1>

    <div id="airtable-setup" class="mb-8 p-6 border rounded-lg bg-yellow-50">
        <h2 class="text-xl font-semibold mb-4">Airtable設定</h2>
        <p class="text-sm text-gray-700 mb-4">
            Airtableの設定情報をスクリプト内に入力してください。
            Personal Access TokenとBase IDが必要です。
        </p>
        <div class="space-y-2 text-sm">
            <p class="font-mono bg-white p-2 rounded">const AIRTABLE_TOKEN = 'あなたのトークン';</p>
            <p class="font-mono bg-white p-2 rounded">const BASE_ID = 'あなたのBase ID';</p>
        </div>
    </div>

    <div id="connection-area" class="mb-8 p-6 border rounded-lg">
        <h2 class="text-xl font-semibold mb-4">接続設定</h2>
        <div class="space-y-4">
            <input
                type="text"
                id="obniz-id"
                placeholder="obniz ID"
                class="w-full p-2 border rounded"
            >
            <input
                type="number"
                id="led-port"
                placeholder="LEDポート番号 (1-4)"
                min="1"
                max="4"
                class="w-full p-2 border rounded"
            >
            <button
                id="connect-btn"
                class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
            >
                接続
            </button>
            <p id="status" class="text-center font-semibold"></p>
        </div>
    </div>

    <div id="control-area" class="hidden space-y-6">
        <div class="p-6 border rounded-lg">
            <h2 class="text-xl font-semibold mb-4">LED制御</h2>
            <div class="flex gap-2">
                <button
                    id="led-on-btn"
                    class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600"
                >
                    LED ON
                </button>
                <button
                    id="led-off-btn"
                    class="flex-1 bg-red-500 text-white p-2 rounded hover:bg-red-600"
                >
                    LED OFF
                </button>
            </div>
        </div>

        <div class="p-6 border rounded-lg">
            <h2 class="text-xl font-semibold mb-4">センサー値</h2>
            <p class="text-lg">電圧: <span id="voltage" class="font-mono font-bold">--</span> V</p>
            <p class="text-lg">明るさ: <span id="brightness-percent" class="font-mono font-bold text-blue-600">--</span> %</p>
        </div>

        <div class="p-6 border rounded-lg bg-green-50">
            <h2 class="text-xl font-semibold mb-4">ログ記録</h2>
            <button
                id="save-log-btn"
                class="w-full bg-purple-500 text-white p-3 rounded hover:bg-purple-600 font-semibold"
            >
                現在の状態をログに保存
            </button>
        </div>

        <div class="p-6 border rounded-lg">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">最新ログ（10件）</h2>
                <button
                    id="load-logs-btn"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                >
                    ログを読み込む
                </button>
            </div>
            <ul id="logs-list" class="space-y-2">
                <li class="text-gray-500 text-center py-4">ログを読み込むボタンをクリックしてください</li>
            </ul>
        </div>
    </div>

    <script src="https://unpkg.com/obniz/obniz.js"></script>
    <script>
        // Airtable設定（ここに自分の値を入力してください）
        const AIRTABLE_TOKEN = 'あなたのPersonal Access Token';
        const BASE_ID = 'あなたのBase ID';
        const TABLE_NAME = '操作ログ';

        let obniz;
        let myPort;
        let led;
        let currentVoltage = 0;
        let currentPercent = 0;

        // 接続処理
        document.getElementById('connect-btn').addEventListener('click', async () => {
            const obnizId = document.getElementById('obniz-id').value.trim();
            myPort = parseInt(document.getElementById('led-port').value);

            if (!obnizId || isNaN(myPort) || myPort < 1 || myPort > 4) {
                alert('入力内容を確認してください');
                return;
            }

            // obnizに接続（複数クライアント同時接続のための設定）
            obniz = new Obniz(obnizId, {
                local_connect: false  // 重要: 複数人で同時接続するために必須
            });

            obniz.onconnect = async () => {
                document.getElementById('status').textContent = '接続成功！';
                document.getElementById('status').className = 'text-center font-semibold text-green-600';
                document.getElementById('control-area').classList.remove('hidden');

                // LEDオブジェクトを作成
                led = obniz.wired('LED', { anode: myPort, cathode: 'gnd' });

                // センサー値の継続監視（推奨方法）
                obniz.ad0.start(function(voltage) {
                    currentVoltage = voltage;
                    currentPercent = Math.round((voltage / 5.0) * 100);

                    document.getElementById('voltage').textContent = currentVoltage.toFixed(2);
                    document.getElementById('brightness-percent').textContent = currentPercent;
                });
            };
        });

        // LED ON
        document.getElementById('led-on-btn').addEventListener('click', () => {
            if (led) {
                led.on();
                saveLog('LED ON');
            }
        });

        // LED OFF
        document.getElementById('led-off-btn').addEventListener('click', () => {
            if (led) {
                led.off();
                saveLog('LED OFF');
            }
        });

        // ログ保存ボタン
        document.getElementById('save-log-btn').addEventListener('click', () => {
            saveLog('手動保存');
        });

        // ログ読み込みボタン
        document.getElementById('load-logs-btn').addEventListener('click', () => {
            loadLogs();
        });

        // Airtableにログを保存
        async function saveLog(action) {
            // 設定チェック
            if (AIRTABLE_TOKEN === 'あなたのPersonal Access Token' || BASE_ID === 'あなたのBase ID') {
                alert('スクリプト内のAirtable設定（AIRTABLE_TOKEN, BASE_ID）を入力してください');
                return;
            }

            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            records: [{
                                fields: {
                                    'ポート': myPort,
                                    '操作': action,
                                    '電圧': currentVoltage,
                                    'タイムスタンプ': new Date().toISOString()
                                }
                            }]
                        })
                    }
                );

                const data = await response.json();

                if (response.ok) {
                    console.log('ログ保存成功:', data);
                    alert('ログを保存しました！');
                } else {
                    console.error('エラー:', data);
                    alert('ログ保存に失敗しました: ' + (data.error?.message || '不明なエラー'));
                }
            } catch (error) {
                console.error('通信エラー:', error);
                alert('通信エラーが発生しました');
            }
        }

        // Airtableからログを読み込む
        async function loadLogs() {
            // 設定チェック
            if (AIRTABLE_TOKEN === 'あなたのPersonal Access Token' || BASE_ID === 'あなたのBase ID') {
                alert('スクリプト内のAirtable設定（AIRTABLE_TOKEN, BASE_ID）を入力してください');
                return;
            }

            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}?maxRecords=10&sort[0][field]=タイムスタンプ&sort[0][direction]=desc`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_TOKEN}`
                        }
                    }
                );

                const data = await response.json();

                if (response.ok) {
                    displayLogs(data.records);
                } else {
                    console.error('エラー:', data);
                    alert('ログ読み込みに失敗しました: ' + (data.error?.message || '不明なエラー'));
                }
            } catch (error) {
                console.error('通信エラー:', error);
                alert('通信エラーが発生しました');
            }
        }

        // ログを表示
        function displayLogs(records) {
            const logsList = document.getElementById('logs-list');
            logsList.innerHTML = '';

            if (records.length === 0) {
                const li = document.createElement('li');
                li.className = 'text-gray-500 text-center py-4';
                li.textContent = 'ログがありません';
                logsList.appendChild(li);
                return;
            }

            records.forEach(record => {
                const fields = record.fields;
                const li = document.createElement('li');
                li.className = 'p-3 bg-gray-50 rounded border';

                const timestamp = new Date(fields['タイムスタンプ']).toLocaleString('ja-JP');
                const port = fields['ポート'];
                const action = fields['操作'];
                const voltage = fields['電圧'];

                li.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-mono text-sm text-gray-600">${timestamp}</span>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-semibold">ポート${port}</span>
                    </div>
                    <div class="mt-2">
                        <span class="font-semibold">${action}</span>
                        <span class="ml-4 text-gray-600">${voltage.toFixed(2)} V</span>
                    </div>
                `;

                logsList.appendChild(li);
            });
        }
    </script>
</body>
</html>
