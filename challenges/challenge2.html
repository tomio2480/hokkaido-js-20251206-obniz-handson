<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課題2: スライダーを使ったLED制御</title>
    <script src="https://cdn.tailwindcss.com/4.0.0-beta.6"></script>
</head>
<body class="p-8 max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">課題2: スライダーを使ったLED制御</h1>

    <div id="connection-area" class="mb-8 p-6 border rounded-lg">
        <h2 class="text-xl font-semibold mb-4">接続設定</h2>
        <div class="space-y-4">
            <input
                type="text"
                id="obniz-id"
                placeholder="obniz ID"
                class="w-full p-2 border rounded"
            >
            <input
                type="number"
                id="led-port"
                placeholder="LEDポート番号 (1-4)"
                min="1"
                max="4"
                class="w-full p-2 border rounded"
            >
            <button
                id="connect-btn"
                class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
            >
                接続
            </button>
        </div>
    </div>

    <div id="control-area" class="hidden space-y-6">
        <div class="p-6 border rounded-lg">
            <h2 class="text-xl font-semibold mb-4">LED制御</h2>
            <div class="flex gap-2 mb-4">
                <button
                    id="led-on-btn"
                    class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600"
                >
                    LED ON
                </button>
                <button
                    id="led-off-btn"
                    class="flex-1 bg-red-500 text-white p-2 rounded hover:bg-red-600"
                >
                    LED OFF
                </button>
            </div>

            <h3 class="text-lg font-semibold mb-2">明るさ調整</h3>
            <div class="space-y-2">
                <input
                    type="range"
                    id="brightness-slider"
                    min="0"
                    max="100"
                    value="50"
                    class="w-full"
                >
                <p class="text-center text-lg">
                    明るさ: <span id="brightness-display" class="font-mono font-bold text-blue-600">50</span>%
                </p>
            </div>
        </div>

        <div class="p-6 border rounded-lg">
            <h2 class="text-xl font-semibold mb-4">センサー値</h2>
            <div class="space-y-2">
                <p class="text-lg">電圧: <span id="brightness-value" class="font-mono font-bold">--</span> V</p>
                <p class="text-lg">明るさ: <span id="brightness-percent" class="font-mono font-bold text-blue-600">--</span> %</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/obniz/obniz.js"></script>
    <script>
        let obniz;
        let myPort;
        let led;
        let pwm;

        // 接続ボタンのクリックイベント
        document.getElementById('connect-btn').addEventListener('click', async () => {
            const obnizId = document.getElementById('obniz-id').value;
            myPort = parseInt(document.getElementById('led-port').value);

            // 入力チェック
            if (!obnizId || myPort < 1 || myPort > 4 || isNaN(myPort)) {
                alert('obniz IDとLEDポート番号（1-4）を正しく入力してください');
                return;
            }

            // obnizに接続（複数クライアント同時接続のための設定）
            obniz = new Obniz(obnizId, {
                local_connect: false  // 重要: 複数人で同時接続するために必須
            });

            obniz.onconnect = async () => {
                console.log('obnizに接続しました');
                alert(`接続成功！あなたのLEDポート: ${myPort}`);

                // LEDオブジェクトを作成
                led = obniz.wired('LED', { anode: myPort, cathode: 'gnd' });

                // PWMオブジェクトを取得して初期化
                pwm = obniz.getFreePwm();
                pwm.start({ io: myPort });
                pwm.freq(1000);  // 1000Hzに設定

                // センサー値の継続監視（推奨方法）
                obniz.ad0.start(function(voltage) {
                    // 電圧値を表示
                    document.getElementById('brightness-value').textContent =
                        voltage.toFixed(2);

                    // 電圧値を%に変換（5V基準）
                    const percent = Math.round((voltage / 5.0) * 100);
                    document.getElementById('brightness-percent').textContent = percent;

                    // 全員に共有
                    obniz.send({
                        type: 'sensor_update',
                        voltage: voltage,
                        percent: percent,
                        from: myPort
                    });
                });

                document.getElementById('control-area').classList.remove('hidden');
            };

            // メッセージ受信
            obniz.onmessage = (message) => {
                // センサー値の受信（他の参加者からも受信）
                if (message.type === 'sensor_update') {
                    console.log(`ポート${message.from}からセンサー値: ${message.voltage}V (${message.percent}%)`);
                }

                // LED状態の受信
                if (message.type === 'led_update') {
                    console.log(`ポート${message.port}: ${message.state}`);
                }
            };
        });

        // LED ONボタン
        document.getElementById('led-on-btn').addEventListener('click', () => {
            if (led) {
                led.on();
                // 状態を全員に共有
                obniz.send({ type: 'led_update', port: myPort, state: 'on' });
            }
        });

        // LED OFFボタン
        document.getElementById('led-off-btn').addEventListener('click', () => {
            if (led) {
                led.off();
                // 状態を全員に共有
                obniz.send({ type: 'led_update', port: myPort, state: 'off' });
            }
        });

        // スライダーの変更イベント
        document.getElementById('brightness-slider').addEventListener('input', (e) => {
            const ratio = parseInt(e.target.value);
            document.getElementById('brightness-display').textContent = ratio;

            // PWM制御
            if (pwm) {
                pwm.duty(ratio);  // デューティ比を変更

                // 状態を全員に共有
                obniz.send({
                    type: 'led_update',
                    port: myPort,
                    state: 'pwm',
                    duty: ratio
                });
            }
        });
    </script>
</body>
</html>
